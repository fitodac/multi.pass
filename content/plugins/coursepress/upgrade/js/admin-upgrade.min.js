/*!  - v2.1.0.2
 * https://premium.wpmudev.org/project/coursepress-pro/
 * Copyright (c) 2017; * Licensed GPLv2+ */

_.extend(_coursepress_upgrade,{totalCourses:0,totalSuccess:0,totalSend:0,events:Backbone.Events,upgrade:Backbone.Model.extend({url:_coursepress_upgrade.ajax_url+"?action=coursepress_upgrade_from_1x",initialize:function(e){_.extend(this,e),this.on("error",this.server_error,this);var s={_wpnonce:_coursepress_upgrade._wpnonce,course_id:this.course_id,user_id:this.user_id,container:!1,total_courses:_coursepress_upgrade.totalCourses,total_success:_coursepress_upgrade.totalSuccess};this.set(s),this.save()},parse:function(e){var s=this.container.$el.find(".course-progress");e&&(e.success?s.hasClass("error")||(s.addClass("success"),_coursepress_upgrade.totalSuccess+=1):s.hasClass("success")||(s.addClass("error"),_coursepress_upgrade.totalError+=1)),_coursepress_upgrade.totalSend+=1,_coursepress_upgrade.events.trigger("coursepress_update_done",this)},server_error:function(){window.alert(_coursepress_upgrade.server_error)}}),checkStudents:Backbone.Model.extend({url:_coursepress_upgrade.ajax_url+"?action=coursepress_upgrade_from_1x",initialize:function(e){_.extend(this,e),this.on("error",this.server_error,this),this.set({_wpnonce:_coursepress_upgrade._wpnonce,type:"check-students",course_id:-1})},parse:function(e){0!==e?e.success?e.data.remaining_students<=0?_coursepress_upgrade.events.trigger("all_students_upgraded",this):_coursepress_upgrade.events.trigger("students_upgraded",e.data.remaining_students,this):_coursepress_upgrade.events.trigger("students_upgrade_failed",this):_coursepress_upgrade.events.trigger("all_students_upgraded",this)},server_error:function(){window.alert(_coursepress_upgrade.server_error)}}),studentsView:Backbone.View.extend({className:"coursepress-update-view",template:'<span class="students-upgrade-message"></span> <span class="students-progress"></span> <span class="course-progress"></span>',initialize:function(e){_.extend(this,e),this.remaining_students="",_coursepress_upgrade.events.on("students_upgraded",_.bind(this.students_upgraded,this)),_coursepress_upgrade.events.on("all_students_upgraded",_.bind(this.all_students_upgraded,this)),_coursepress_upgrade.events.on("students_upgrade_failed",_.bind(this.students_upgrade_failed,this))},students_upgraded:function(e){this.remaining_students=e,this.render()},all_students_upgraded:function(){this.$el.find(".students-progress").html("0"),this.$el.find(".course-progress").removeClass("error").addClass("success")},students_upgrade_failed:function(){this.$el.find(".course-progress").removeClass("success").addClass("error")},render:function(){this.$el.html(this.template),this.$el.find(".students-upgrade-message").html(_coursepress_upgrade.upgrading_students),this.$el.find(".students-progress").html(this.remaining_students),this.$el.insertBefore(this.submit_button),new _coursepress_upgrade.checkStudents({}).save()}}),view:Backbone.View.extend({className:"coursepress-update-view",input:!1,template:'<span class="course-title"></span> <span class="course-progress"></span>',initialize:function(e){_.extend(this,e),this.render()},render:function(){if(this.input){var e,s;s=this.input.val(),this.input.parents().find("#cp-updated-"+s).remove(),e=this.input.data("name"),this.$el.append(this.template),this.$el.attr("id","cp-updated-"+s),this.$el.find(".course-title").html(e),this.$el.insertAfter(this.input),""!==this.input.data("done")?(_coursepress_upgrade.totalSuccess+=1,_coursepress_upgrade.totalSend+=1,this.$el.find(".course-progress").addClass("success"),_coursepress_upgrade.events.trigger("coursepress_update_done",this)):this.sync=new _coursepress_upgrade.upgrade({course_id:this.input.val(),type:this.input.data("type"),container:this,user_id:this.user_id})}}})}),function(e){e(document).on("submit","#coursepress-update-form",function(){function s(){var s=l.get(g);i=new _coursepress_upgrade.view({input:e(s),user_id:v}),g++}function r(){h.parent().removeClass("notice-warning").addClass("notice-error"),h.html(_coursepress_upgrade.failed)}function t(){h.parent().removeClass("notice-warning"),h.html(_coursepress_upgrade.success),d=5,a=setInterval(function(){d-=1,h.find(".coursepress-counter").html(d),0===d&&(clearInterval(a),window.location=_coursepress_upgrade.cp2_url)},1e3)}var u,n,a,d,i,o,p,c,_=e(this),l=e('[name="course"]',_),g=0,h=e(".coursepress-upgrade-nag p"),v=e('[name="user_id"]',_).val(),f=_.find('[type="submit"]');return!f.is(":disabled")&&(0===h.length&&(n=e(".coursepress-upgrade-view h2"),h=e('<div class="notice notice-warning is-dismissible coursepress-upgrade-nag">').insertAfter(n),h=e("<p>").appendTo(h)),f.attr("disabled","disabled"),h.parent().removeClass("notice-error").addClass("notice-warning"),h.html(_coursepress_upgrade.noloading),_coursepress_upgrade.totalCourses=l.length,_coursepress_upgrade.totalSend=0,_coursepress_upgrade.totalSuccess=0,s(),u=function(){_coursepress_upgrade.totalCourses===_coursepress_upgrade.totalSend?_coursepress_upgrade.totalCourses===_coursepress_upgrade.totalSuccess?(c=new _coursepress_upgrade.studentsView({submit_button:f.closest("p")})).render():r():s()},o=function(){clearInterval(void 0),t()},p=function(){clearInterval(void 0),r()},_coursepress_upgrade.events.off("coursepress_update_done"),_coursepress_upgrade.events.on("coursepress_update_done",u),_coursepress_upgrade.events.on("all_students_upgraded",o),_coursepress_upgrade.events.on("students_upgrade_failed",p),!1)})}(jQuery);
